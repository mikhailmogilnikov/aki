<script is:inline type="module">
  (async () => {
    await new Promise((resolve, reject) => {
      const link = document.createElement("link");
      link.rel = "stylesheet";
      link.href = "/squircle.css";
      link.onload = () => resolve();
      link.onerror = () => reject(new Error("Failed to load CSS"));
      document.head.appendChild(link);
    });

    if (!("paintWorklet" in CSS)) {
      await import("/scripts/css-paint-polyfill.js");

      await new Promise((resolve) => {
        const checkPaintWorklet = () => {
          if (CSS.paintWorklet && CSS.paintWorklet.addModule) {
            resolve();
          } else {
            setTimeout(checkPaintWorklet, 50);
          }
        };
        checkPaintWorklet();
      });

      await new Promise((resolve) => setTimeout(resolve, 100));
    }

    try {
      await CSS.paintWorklet.addModule("/scripts/squircle.min.js");

      forceRepaintSquircleElements();
    } catch (error) {
      console.warn("Failed to load squircle paintWorklet:", error);

      setTimeout(async () => {
        try {
          await CSS.paintWorklet.addModule("/scripts/squircle.min.js");
          forceRepaintSquircleElements();
        } catch (retryError) {
          console.error(
            "Failed to load squircle paintWorklet on retry:",
            retryError
          );
        }
      }, 200);
    }

    function forceRepaintSquircleElements() {
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          const squircleElements = document.querySelectorAll(
            ".squircle, .squircle-outline, .squircle-shadow"
          );

          squircleElements.forEach((element) => {
            const originalTransform = element.style.transform;
            element.style.transform = "translateZ(0)";

            requestAnimationFrame(() => {
              element.style.transform = originalTransform;
            });
          });
        });
      });
    }
  })();
</script>

<script is:inline type="module">
  (async () => {
    await new Promise((resolve, reject) => {
      const link = document.createElement("link");
      link.rel = "stylesheet";
      link.href = "/squircle.css";
      link.onload = () => {
        // ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð·Ð°ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ð¾Ð»Ð¸Ñ„Ð¸Ð»Ð» Ð¿ÐµÑ€ÐµÐ¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ ÑÑ‚Ð¸Ð»Ð¸ Ð¿Ð¾ÑÐ»Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ CSS
        setTimeout(() => {
          // Ð¡Ð¿Ð¾ÑÐ¾Ð± 1: Ð’Ñ‹Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð²Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½Ð¸Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð¿Ð¾Ð»Ð¸Ñ„Ð¸Ð»Ð»Ð°
          if (typeof window.$$paintWorkletUpdate === 'function') {
            window.$$paintWorkletUpdate();
          }
          
          // Ð¡Ð¿Ð¾ÑÐ¾Ð± 2: Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¸ ÑƒÐ´Ð°Ð»ÑÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ ÑÑ‚Ð¸Ð»ÑŒ Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ñ‚Ñ€Ð¸Ð³Ð³ÐµÑ€Ð¸Ñ‚ÑŒ MutationObserver
          const tempStyle = document.createElement('style');
          tempStyle.textContent = '.temp-squircle { background: paint(squircle); }';
          document.head.appendChild(tempStyle);
          setTimeout(() => {
            document.head.removeChild(tempStyle);
          }, 10);
          
          // Ð¡Ð¿Ð¾ÑÐ¾Ð± 3: Ð¢Ñ€Ð¸Ð³Ð³ÐµÑ€Ð¸Ð¼ resize event
          const updateEvent = new Event('resize');
          window.dispatchEvent(updateEvent);
          
          resolve();
        }, 50);
      };
      link.onerror = () => reject(new Error("Failed to load CSS"));
      document.head.appendChild(link);
    });

    if (!("paintWorklet" in CSS)) {
      await import("/scripts/css-paint-polyfill.js");

      await new Promise((resolve) => {
        const checkPaintWorklet = () => {
          if (CSS.paintWorklet && CSS.paintWorklet.addModule) {
            resolve();
          } else {
            setTimeout(checkPaintWorklet, 50);
          }
        };
        checkPaintWorklet();
      });

      await new Promise((resolve) => setTimeout(resolve, 100));
    }

    try {
      await CSS.paintWorklet.addModule("/scripts/squircle.min.js");

              forceRepaintSquircleElements();
        
        // ÐžÑ‚Ð»Ð°Ð´Ð¾Ñ‡Ð½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ð¾Ð½Ð¸Ð¼Ð°Ð½Ð¸Ñ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹
        setTimeout(() => {
          const squircleElements = document.querySelectorAll('.squircle, .squircle-outline, .squircle-shadow');
          const elementsWithDataAttr = document.querySelectorAll('[data-css-paint]');
          
          console.log('ðŸ” Squircle Debug Safari:', {
            'CSS Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½': !!document.querySelector('link[href="/squircle.css"]'),
            'Worklet Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½': !!window.CSS.paintWorklet,
            'Ð­Ð»ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð² Ñ ÐºÐ»Ð°ÑÑÐ°Ð¼Ð¸': squircleElements.length,
            'Ð­Ð»ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð² Ñ data-css-paint': elementsWithDataAttr.length,
            'ÐŸÐ¾Ð»Ð¸Ñ„Ð¸Ð»Ð» Ð°ÐºÑ‚Ð¸Ð²ÐµÐ½': typeof CSS.paintWorklet?.addModule === 'function' && !CSS.paintWorklet.addModule.toString().includes('[native code]'),
            'ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð½Ñ‹Ðµ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹': Array.from(squircleElements).filter(el => !el.getAttribute('data-css-paint')).length
          });
          
          // Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹ Ð±ÐµÐ· data-css-paint, Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¸Ñ… ÑÑ‚Ð¸Ð»Ð¸
          const problematic = Array.from(squircleElements).filter(el => !el.getAttribute('data-css-paint'));
          if (problematic.length > 0) {
            console.log('ðŸš¨ Ð­Ð»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹ Ð±ÐµÐ· data-css-paint:', problematic.map(el => ({
              element: el,
              computedStyles: {
                background: getComputedStyle(el).background,
                maskImage: getComputedStyle(el).maskImage
              }
            })));
          }
        }, 500);
      } catch (error) {
      console.warn("Failed to load squircle paintWorklet:", error);

      setTimeout(async () => {
        try {
          await CSS.paintWorklet.addModule("/scripts/squircle.min.js");
          forceRepaintSquircleElements();
        } catch (retryError) {
          console.error(
            "Failed to load squircle paintWorklet on retry:",
            retryError
          );
        }
      }, 200);
    }

          function forceRepaintSquircleElements() {
        const squircleElements = document.querySelectorAll(
          ".squircle, .squircle-outline, .squircle-shadow"
        );

        if (squircleElements.length === 0) {
          // Ð•ÑÐ»Ð¸ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹ ÐµÑ‰Ðµ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ñ‡ÐµÑ€ÐµÐ· MutationObserver
          setupSquircleObserver();
          return;
        }

        squircleElements.forEach((element) => {
          // ÐœÐµÑ‚Ð¾Ð´ 1: ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ ÐºÐ»Ð°ÑÑÐ¾Ð²
          const classes = Array.from(element.classList).filter(cls => 
            cls.includes('squircle')
          );
          
          classes.forEach(cls => {
            element.classList.remove(cls);
            element.offsetHeight; // ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ reflow
            element.classList.add(cls);
          });

          // ÐœÐµÑ‚Ð¾Ð´ 2: ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ CSS Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð¹ (ÐµÑÐ»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ)
          const currentRadius = getComputedStyle(element).getPropertyValue('--squircle-radius');
          if (currentRadius) {
            element.style.setProperty('--squircle-radius', currentRadius);
          }
        });
      }

      // ÐÐ°Ð±Ð»ÑŽÐ´Ð°Ñ‚ÐµÐ»ÑŒ Ð·Ð° Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸ÑÐ¼Ð¸ DOM Ð´Ð»Ñ Ð´Ð¸Ð½Ð°Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼Ñ‹Ñ… ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð²
      function setupSquircleObserver() {
        const observer = new MutationObserver((mutations) => {
          let hasSquircleElements = false;
          
          mutations.forEach((mutation) => {
            mutation.addedNodes.forEach((node) => {
              if (node.nodeType === Node.ELEMENT_NODE) {
                if (node.matches?.('.squircle, .squircle-outline, .squircle-shadow') ||
                    node.querySelector?.('.squircle, .squircle-outline, .squircle-shadow')) {
                  hasSquircleElements = true;
                }
              }
            });
          });

          if (hasSquircleElements) {
            setTimeout(() => {
              forceRepaintSquircleElements();
            }, 50);
          }
        });

        observer.observe(document.body, {
          childList: true,
          subtree: true
        });

        // ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ observer Ñ‡ÐµÑ€ÐµÐ· 10 ÑÐµÐºÑƒÐ½Ð´ Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ñ‚Ñ€Ð°Ñ‚Ð¸Ñ‚ÑŒ Ñ€ÐµÑÑƒÑ€ÑÑ‹
        setTimeout(() => observer.disconnect(), 10000);
      }

      // ÐœÐ½Ð¾Ð³Ð¾ÑƒÑ€Ð¾Ð²Ð½ÐµÐ²Ð°Ñ ÑÑ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ñ Ð´Ð»Ñ Safari
      const safariRetrySchedule = [100, 300, 500, 1000, 2000];
      
      safariRetrySchedule.forEach(delay => {
        setTimeout(forceRepaintSquircleElements, delay);
      });

      // Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ fallback Ð´Ð»Ñ Ð¿Ð¾Ð»Ð½Ð¾Ð¹ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          setTimeout(forceRepaintSquircleElements, 50);
          setTimeout(forceRepaintSquircleElements, 200);
        });
      }
      
      window.addEventListener('load', () => {
        setTimeout(forceRepaintSquircleElements, 100);
        setTimeout(forceRepaintSquircleElements, 500);
      });

      // ÐŸÐ¾ÑÐ»ÐµÐ´Ð½ÑÑ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð¿Ñ€Ð¸ Ð²Ð·Ð°Ð¸Ð¼Ð¾Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
      const userInteractionEvents = ['scroll', 'mousemove', 'touchstart', 'click'];
      let interactionAttempted = false;
      
      userInteractionEvents.forEach(event => {
        document.addEventListener(event, () => {
          if (!interactionAttempted) {
            interactionAttempted = true;
            setTimeout(forceRepaintSquircleElements, 100);
          }
        }, { once: true, passive: true });
      });
  })();
</script>
